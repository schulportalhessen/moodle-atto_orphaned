YUI.add("moodle-atto_orphaned-button",function(l,e){var s={},r={},o={},g={},d={},h={},p={},c={},u={},f={},m={};l.namespace("M.atto_orphaned").Button=l.Base.create("button",l.M.editor_atto.EditorPlugin,[],{orpanedArea:null,config:null,elementId:null,initializer:function(e){var t,i,a,n;if(this.config=e,"0"!=this.config.enablePlugin&&"1"==this.config.hascapability&&("0"!=this.config.showAllFilesCounter||"0"!=this.config.showOrphanedFilesCounter)){for(n in t=(e=this.get("host"))._wrapper,i=e.get("elementid"),this.elementId=i,a=this.get("host").get("filepickeroptions"),e=this.get("host").get("filepickeroptions").image,r[i]=e.client_id,g[i]=1,d[i]=!1,h[i]=0,c[i]=!1,u[i]={},f[i]=0,a)"undefined"!=typeof a[n].itemid&&(s[i]=a[n].itemid);e=this.config.usercontext,p[i]=M.cfg.wwwroot+"/draftfile.php/"+e+"/user/draft/"+s[i],this.orpanedArea=l.Node.create('<div id="js-orphaned-wrapper-'+i+'" class="js-orphaned-wrapper">'+this.renderOrphanedFilesArea(i)+this.renderAllFilesArea(i)+"</div>"),t.appendChild(this.orpanedArea),(o[i]=this).get("host").on("pluginsloaded",function(){setTimeout(function(){d[i]=!1,o[i]._onChangeParser()},500),d[i]=!1,this.get("host").on("atto:selectionchanged",this._onChangeParser,this);var e=document.getElementById(i);m[i]=e.previousSibling.getElementsByClassName("atto_html_button")[0],m[i].onclick=function(){setTimeout(function(){o[i]._toggleCodeMirrorStatus(i)},500)}},this)}},renderOrphanedFilesArea:function(e){var t="";return t="1"==this.config.showOrphanedFilesCounter?"1"==this.config.showOrphanedFilesTable?'<details class="orphaned-files-details" id="orphaned-files-details-'+e+'" open><summary><span class="orphaned-label align-middle">'+M.util.get_string("label:dropdownorphanedfilescount","atto_orphaned")+'<span class="orphanedFilesCount" id="orphanedFilesCount-'+e+'">substitute orphanedFilesCount</span>'+M.util.get_string("label:filescountermaxpre","atto_orphaned")+'<span class="maxcounter">'+this.config.maxOrphanedFilesCounter+" "+M.util.get_string("label:filescountermaxpost","atto_orphaned")+'</span></span></summary><span id="orphanedFilesArea-'+e+'" class="align-middle shadow"></span></details>':'<div class="orphaned-files-details" id="orphaned-files-details-'+e+'"><span class="orphaned-label align-middle">'+M.util.get_string("label:dropdownorphanedfilescount","atto_orphaned")+'<span class="orphanedFilesCount" id="orphanedFilesCount-'+e+'">substitute orphanedFilesCount</span></span></div>':t},renderAllFilesArea:function(e){var t="";return t="1"==this.config.showAllFilesCounter?"1"==this.config.showAllFilesTable?'<details class="all-files-details" id="all-files-details-'+e+'"><summary><span class="orphaned-label align-middle">'+M.util.get_string("label:dropdownallfilescount","atto_orphaned")+'<span class="allFilesCount" id="allFilesCount-'+e+'">x</span>'+M.util.get_string("label:filescountermaxpre","atto_orphaned")+'<span class="maxcounter">'+this.config.maxAllFilesCounter+" "+M.util.get_string("label:filescountermaxpost","atto_orphaned")+'</span></span></summary><span id="allFilesTableArea-'+e+'" class="align-middle">x</span></details>':'<div  class="all-files-details" id="all-files-details-'+e+'"><span class="orphaned-label align-middle">'+M.util.get_string("label:dropdownallfilescount","atto_orphaned")+'<span class="allFilesCount" id="allFilesCount-'+e+'">x</span></span></div>':t},_toggleCodeMirrorStatus:function(t){var e,i=null,a=document.getElementById(t),a=a.nextSibling,n=!1;(n="undefined"!=typeof a.classList?a.classList.contains("CodeMirror"):n)?(e=l.one("#"+a.id),c[t]=!0,l.one("#js-orphaned-wrapper-"+t).remove(),setTimeout(function(){e.insert(o[t].orpanedArea,"after")},500),n=document.querySelector("#"+a.id).querySelector(".CodeMirror-code"),(i=new MutationObserver(function(){d[t]=!0,o[t]._onChangeParser()})).observe(n,{subtree:!0,childList:!0,attributes:!0})):(c[t]=!1,l.one("#js-orphaned-wrapper-"+t).remove(),setTimeout(function(){var e=o[t].get("host"),e=e._wrapper;e.appendChild(o[t].orpanedArea)},500),null!==i&&i.disconnect())},_onChangeParser:function(){var e=h[this.elementId];h[this.elementId]=Object.keys(this._getUsedFiles(this.elementId)).length,1!=g[this.elementId]&&1!=d[this.elementId]&&h[this.elementId]==e||(g[this.elementId]=0,o[this.elementId]._showOrphanedFiles(this.elementId))},_showOrphanedFiles:function(e){var t;c[e]?1===f[e]&&(u[e]=o[e]._getAllFilesAjax("/",null,e),f[e]=0):(u[e]=o[e]._getAllFilesAjax("/",null,e),d[e]=!1,f[e]=0),"1"==this.config.showOrphanedFilesCounter&&(t=this._getUsedFiles(e),t=(t=this._getUnusedFiles(u[e],t)).slice(0,this.config.maxOrphanedFilesCounter),l.one("#orphanedFilesCount-"+e).empty(),l.one("#orphanedFilesCount-"+e).insert(l.Node.create(t.length)),"1"==this.config.showOrphanedFilesTable&&(l.one("#orphanedFilesArea-"+e).empty(),0<t.length&&(t=l.Node.create(this.renderTable(!0,"orphanedFilesTable",t,e)),l.one("#orphanedFilesArea-"+e).insert(t),"undefined"!=typeof sorttable&&sorttable.makeSortable(l.one("#orphanedFilesTable-"+e).getDOMNode())))),"1"==this.config.showAllFilesCounter&&(t=u[e],t=Object.fromEntries(Object.entries(t).slice(0,this.config.maxAllFilesCounter)),l.one("#allFilesCount-"+e).empty(),l.one("#allFilesCount-"+e).insert(l.Node.create(Object.keys(u[e]).length)),"1"==this.config.showAllFilesTable&&(l.one("#allFilesTableArea-"+e).empty(),0<Object.keys(u[e]).length&&(l.one("#allFilesTableArea-"+e).insert(l.Node.create(this.renderTable(!1,"allFilesTable",t,e))),"undefined"!=typeof sorttable&&sorttable.makeSortable(l.one("#allFilesTable-"+e).getDOMNode()))))},renderTable:function(e,t,i,a){var n,t='<table id="'+t+"-"+a+'" class="sortable table table-sm table-hover table-bordered"><caption>'+M.util.get_string(t+":caption","atto_orphaned")+'</caption><thead><tr><th scope="col" title="'+M.util.get_string("tableheadersortorder:referencecount","atto_orphaned")+'" style="width:25px;" ></th><th scope="col" title="'+M.util.get_string("tableheadersortorder:mimetype","atto_orphaned")+'">'+M.util.get_string(
"tableheader:preview","atto_orphaned")+'</th><th scope="col" title="'+M.util.get_string("tableheader:filesize","atto_orphaned")+'">'+M.util.get_string("tableheader:filesize","atto_orphaned")+'</th><th scope="col" title="'+M.util.get_string("tableheader:filename","atto_orphaned")+'">'+M.util.get_string("tableheader:filename","atto_orphaned")+'</th><th scope="col" title="'+M.util.get_string("tableheader:path","atto_orphaned")+'">'+M.util.get_string("tableheader:path","atto_orphaned")+'</th><th scope="col" title="'+M.util.get_string("tableheader:creationdate","atto_orphaned")+'">'+M.util.get_string("tableheader:creationdate","atto_orphaned")+"</th></tr></thead><tbody>",l="";for(n in i)l+=this.renderTableRow(e,i,n,a);return t+l+"</tbody></table>"},renderTableRow:function(e,t,i,a){return"<tr>"+this.renderTdTrashIcon(t[i],e,a)+this.renderTdPreview(t[i],a)+this.renderTdFilesize(t[i])+this.renderTdFilename(t[i],a)+this.renderTdFilepath(t[i])+this.renderTdDate(t[i])+"</tr>"},isImage:function(e){return e.match(/.(jpg|jpeg|png|gif)$/i)},isAudio:function(e){return e.match(/.(mp3|aac|flac|m4a|oga|ogg|wav)$/i)},isVideo:function(e){return e.match(/.(mp4|m4v|ogv|webm|fmp4|mov)$/i)},renderTdTrashIcon:function(e,t,i){var a="";return t&&(a='<button aria-label="Delete" type="button" class="singledeletion" onclick="Y.M.atto_orphaned.Button.prototype._deleteFile(\''+e.filepath+"', '"+e.filename+"', '"+i+'\')"><i class="fa fa-trash" aria-hidden="true" title="'+M.util.get_string("label:trashicon","atto_orphaned")+'"></i></button><span class="sr-only">'+M.util.get_string("label:trashicon","atto_orphaned")+"</span>"),'<td sorttable_customkey="'+e.refcount+'">'+a+"</td>"},renderTdPreview:function(e,t){var i=e.filename;return this.isImage(e.filename)&&"1"==this.config.showPreviewOfImage&&(i=' <img class="atto-orphaned-img" src="'+p[t]+e.filepath+e.filename+'?preview=thumb" alt="'+e.filepath+e.filename+'" class="atto-orphaned-preview-image">'),this.isAudio(e.filename)&&"1"==this.config.showPreviewOfAudio&&(i='<audio controls preload="none"><source src="'+p[t]+e.filepath+e.filename+'" type="audio/ogg"></audio>'),this.isVideo(e.filename)&&"1"==this.config.showPreviewOfVideo&&(i='<video class="atto-orphaned-preview-video" controls preload="none" title="'+e.filename+'"><source src="'+p[t]+e.filepath+e.filename+'" type="video/mp4">   </video><br>'),'<td sorttable_customkey="'+e.mimetype+'"> <a target="_blank" href="'+p[t]+e.filepath+e.filename+'">'+i+"</a></td>"},renderTdFilesize:function(e){return'<td sorttable_customkey="'+e.size+'">'+e.filesize+"</td>"},renderFileDetails:function(e){var t,i,a,n="";return this.isImage(e.filename)&&(n=M.util.get_string("dimensions","atto_orphaned")+e.dimensions),t=this.config.showIsReferenz,a=this.config.showReferenceCount,i=this.config.showMimetype,"1"==a&&!e.isref&&0<e.refcount&&(n=n+'<br><i class="fa fa-chain" aria-hidden="true"></i> '+M.util.get_string("referencecount","atto_orphaned")+("undefined"!=typeof e.refcount?e.refcount:"...")),a=M.util.get_string("isreferenz","atto_orphaned"),"1"==t&&e.isref&&(n+=e.isref?'<br><i class="fa fa-reply fa-flip-horizontal" aria-hidden="true"></i> '+a:""),n="1"==i?n+"<br>"+e.mimetype:n},renderTdFilename:function(e,t){var i=this.renderFileDetails(e);return'<td><a target="_blank" href="'+p[t]+e.filepath+e.filename+'">'+e.filename+"</a><br>"+i+"</td>"},renderTdFilepath:function(e){return"<td>"+e.filepath+"</td>"},renderTdDate:function(e){return"<td>"+e.datecreated_f+"</td>"},_fetchDraftFiles:function(e,t){e={sesskey:M.cfg.sesskey,client_id:r[t],filepath:e,itemid:s[t]},t=M.cfg.wwwroot+"/repository/draftfiles_ajax.php?action=list",t=l.io(t,{sync:!0,data:e,method:"POST"});return 200===t.status?JSON.parse(t.responseText):null},_getAllFilesAjax:function(e,t,i){t=t||{};e=this._fetchDraftFiles(e,i);return null!==e&&0<e.filecount&&e.list.forEach(function(e){"."===e.filename?t=o[i]._getAllFilesAjax(e.filepath,t,i):t[e.filepath.substring(1)+e.filename]={filepath:e.filepath,filename:e.filename,datecreated:e.datecreated,datecreated_f:e.datecreated_f,dimensions:e.dimensions,size:e.size,filesize:e.filesize,isref:e.isref,refcount:e.refcount,mimetype:e.mimetype}}),t},_getUsedFiles:function(e){for(var t,i=c[e]?document.getElementById(e).value:this.get("host").getCleanHTML(),e=p[e]+"/",a=new RegExp(e.replace(/[\-\/\\\^$*+?.()|\[\]{}]/g,"\\$&")+"(.+?)[\\?\"']","gm"),n={};null!==(t=a.exec(i));)n[decodeURIComponent(t[1])]=!0;return n},_deleteFile:function(e,t,i){e={sesskey:M.cfg.sesskey,client_id:r[i],filepath:e,filename:t,itemid:s[i]},t=M.cfg.wwwroot+"/repository/draftfiles_ajax.php?action=delete",t=l.io(t,{sync:!0,data:e,method:"POST"});200===t.status&&(f[i]=1,d[i]=!0,o[i]._onChangeParser())},_getUnusedFiles:function(e,t){var i,a,n,l=[];for(i in e)a=this.config.folderForNotOrphandFiles,n=i.substring(0,a.length),t[i]||n==a||l.push(e[i]);return l=l.sort(function(e,t){return e.datecreated<t.datecreated?1:e.datecreated>t.datecreated?-1:0})}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});